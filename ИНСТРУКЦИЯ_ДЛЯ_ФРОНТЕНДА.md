# Инструкция для фронтенд-разработчика

## Что делает классификатор:

**Автоматически распознаёт 14 танцевальных фигур:**
- Aida, Alemana, Fan, FootChange, HandToHandL, HandToHandR, HockyStick, NaturalTop, NewYorkL, NewYorkR, NotPerforming, OpenBasic, OpeningOut, SpotTurn

**Не нужно указывать, какую фигуру ищем** - модель сама определит!

---

## Быстрый старт (3 шага)

### 1. Скачайте файлы
Ссылка: https://cloud.mail.ru/public/DG9E/EuZWkp6gn

Вам нужны:
- `best_model_20pct.pth` - модель (обучена на 20% данных, точность 83.7%)
- `metadata.json` - метаданные
- `outputs/` - примеры видео и поз

### 2. Положите файлы рядом с кодом
```
ваш_проект/
├── best_model_20pct.pth
├── metadata.json
├── outputs/
└── use_classifier.py  ← этот файл уже в коде!
```

### 3. Используйте!

#### Из командной строки:
```bash
python use_classifier.py outputs/video1/poses.jsonl
```

#### Из Python кода:
```python
from dance_classifier.inference.predict import DanceClassifierPredictor

predictor = DanceClassifierPredictor(
    model_path="best_model_20pct.pth",
    reference_dir=None  # Автоматически найдет в reference_trajectories/
)

result = predictor.predict_from_poses(
    "outputs/video1/poses.jsonl",
    video_path="outputs/video1/video1.mp4"  # Опционально, для timing метрики
)

if result['success']:
    print(f"Движение: {result['predicted_figure']}")
    print(f"Уверенность: {result['confidence']:.2%}")
    
    # Новые метрики качества
    if 'spatial_similarity' in result:
        print(f"Техника: {result['spatial_similarity']['score']:.1f}/100")
    if 'classifier_clarity' in result:
        print(f"Разборчивость: {result['classifier_clarity']['score']:.1f}/100")
    if 'timing' in result:
        print(f"Ритм: {result['timing']['score']:.1f}/100")
    if 'balance' in result:
        print(f"Баланс: {result['balance']['score']:.1f}/100")
else:
    print(f"Ошибка: {result['error']}")
```

#### Из JavaScript/фронтенда (через subprocess):
```javascript
const { exec } = require('child_process');

exec('python use_classifier.py outputs/video1/poses.jsonl', (error, stdout) => {
    if (!error) {
        console.log(stdout);
    }
});
```

---

## Формат результата

### Успешное распознавание:

```json
{
    "success": true,
    "predicted_figure": "Fan",
    "confidence": 0.85,
    "all_predictions": ["Fan", "Fan", "Alemana"],
    "spatial_similarity": {
        "score": 75.5,
        "mean_distance": 12.3,
        "error_segments": []
    },
    "classifier_clarity": {
        "score": 82.3,
        "mean_margin": 0.45,
        "low_confidence_windows": []
    },
    "timing": {
        "score": 68.1,
        "bpm": 120.5,
        "mean_abs_offset": 0.15,
        "onbeat_ratio": 0.72
    },
    "balance": {
        "score": 90.2,
        "mean_tilt_deg": 2.5,
        "tilt_std_deg": 1.8,
        "com_std_norm": 0.05,
        "out_of_corridor_ratio": 0.1
    }
}
```

**Основные поля:**
- `predicted_figure` - название распознанной фигуры (автоматически определяется!)
- `confidence` - уверенность модели (0.0-1.0)
- `all_predictions` - список предсказаний для каждой последовательности

**Новые метрики качества исполнения (опциональные):**

1. **spatial_similarity** - Техника исполнения (0-100)
   - `score` - оценка сходства с эталоном (чем выше, тем лучше)
   - `mean_distance` - среднее расстояние до эталона
   - `error_segments` - сегменты с ошибками

2. **classifier_clarity** - Разборчивость фигуры (0-100)
   - `score` - насколько уверена модель в предсказании
   - `mean_margin` - средний отступ между классами
   - `low_confidence_windows` - окна с низкой уверенностью

3. **timing** - Ритм и синхронизация с музыкой (0-100)
   - `score` - общая оценка ритма
   - `bpm` - темп музыки (удары в минуту)
   - `mean_abs_offset` - среднее отклонение от бита (секунды)
   - `onbeat_ratio` - доля шагов, попавших в такт

4. **balance** - Баланс и стабильность корпуса (0-100)
   - `score` - общая оценка баланса
   - `mean_tilt_deg` - средний наклон корпуса (градусы)
   - `tilt_std_deg` - стабильность наклона
   - `com_std_norm` - стабильность центра масс
   - `out_of_corridor_ratio` - доля времени вне зоны стабильности

**Примечание:** Метрики `timing` вычисляются только если передан `video_path`. Остальные метрики вычисляются автоматически.

**Какие поля выводить в интерфейс:** 
- Обязательно: `predicted_figure`, `confidence`
- Опционально: все метрики качества для детального анализа

### Если ошибка:

```json
{
    "success": false,
    "error": "Not enough frames"
}
```

---

## Пример использования в интерфейсе

```javascript
// Получить результат классификации
const result = classifyVideo("outputs/video1/poses.jsonl");

if (result.success) {
    // Показать название движения (любое из 14!)
    document.getElementById('movement').textContent = result.predicted_figure;
    
    // Показать уверенность в процентах
    const confidencePercent = (result.confidence * 100).toFixed(1);
    document.getElementById('confidence').textContent = confidencePercent + '%';
    
    // Показать видео со скелетом
    const videoPath = "outputs/video1/overlay_video1.mp4";
    document.getElementById('video').src = videoPath;
    
    // Опционально: показать предупреждение при низкой уверенности
    if (result.confidence < 0.5) {
        alert('Низкая уверенность, результат может быть неточным');
    }
} else {
    console.error('Ошибка:', result.error);
}
```

### Пример интерфейса:

```
┌────────────────────────────────┐
│ Движение: Fan                  │
│ Уверенность: 85%               │
│                                 │
│ Метрики качества:              │
│ Техника: 75.5/100              │
│ Разборчивость: 82.3/100         │
│ Ритм: 68.1/100                  │
│ Баланс: 90.2/100                │
│                                 │
│ [Видео со скелетом]              │
└────────────────────────────────┘
```

---

## Решение проблем

### Проблема: "Unsupported global: sklearn..."
Уже исправлено в `use_classifier.py`! Просто используйте этот файл.

### Проблема: "Not enough frames"
Видео слишком короткое. Нужно минимум 30 кадров.

### Проблема: "Model file not found"
Проверьте что `best_model_20pct.pth` лежит в той же папке или укажите путь:
```python
classify_video("poses.jsonl", model_path="путь/к/модели.pth")
```

---

---

## Какие фигуры распознаёт модель:

Модель обучена на **14 фигурах** латиноамериканских танцев:

| № | Фигура | Описание |
|---|--------|----------|
| 1 | Aida | Основное движение |
| 2 | Alemana | Поворот партнёрши |
| 3 | Fan | Веер |
| 4 | FootChange | Смена ног |
| 5 | HandToHandL | Рука к руке (влево) |
| 6 | HandToHandR | Рука к руке (вправо) |
| 7 | HockyStick | Хоккейная клюшка |
| 8 | NaturalTop | Натуральный топ |
| 9 | NewYorkL | Нью-Йорк (влево) |
| 10 | NewYorkR | Нью-Йорк (вправо) |
| 11 | NotPerforming | Не танцует |
| 12 | OpenBasic | Открытый основной шаг |
| 13 | OpeningOut | Раскрытие |
| 14 | SpotTurn | Спот-поворот |

**Модель автоматически определяет фигуру - не нужно указывать заранее!**

---

## Важно:

### Если видео содержит несколько фигур:

Модель вернёт **наиболее часто встречающуюся** фигуру в видео.

Пример:
```json
{
    "predicted_figure": "Fan",  // ← 80% кадров = Fan
    "all_predictions": ["Fan", "Fan", "Fan", "Alemana", "Fan"]
}
```

Для анализа нескольких фигур - разделите видео на части.

### Если уверенность низкая (< 50%):

```javascript
if (result.confidence < 0.5) {
    // Показать предупреждение
    console.warn('Возможно видео содержит неизвестную фигуру или несколько фигур');
}
```

---

## Планируются ли изменения?

**НЕТ, API останется прежним!**

В будущем могут добавиться **опциональные** поля (оценки техники, тайминга и т.д.), но базовые поля (`predicted_figure`, `confidence`) **не изменятся**.

Подробнее: смотри файл `ЧТО_ИЗМЕНИТСЯ_ДЛЯ_ФРОНТЕНДА.md`

---
