# ИНСТРУКЦИЯ ДЛЯ ФРОНТЕНДА

## 1. СКАЧАТЬ КОД

```bash
git clone https://github.com/citec-spbu/coach-assistant.git
cd coach-assistant/dance_classifier
```

## 2. СКАЧАТЬ МОДЕЛЬ С ОБЛАКА

**ССЫЛКА:** https://cloud.mail.ru/public/DG9E/EuZWkp6gn

**СКАЧАТЬ:**
- `models/best_model_20pct.pth` (61 MB)
- `yolov8m-pose.pt` (52 MB)

**ПОЛОЖИТЬ:**
- `best_model_20pct.pth` → `coach-assistant/dance_classifier/models/`
- `yolov8m-pose.pt` → `coach-assistant/`

## 3. УСТАНОВИТЬ ЗАВИСИМОСТИ

```bash
pip install -r requirements.txt
```

## 4. КОД ДЛЯ ИСПОЛЬЗОВАНИЯ

```python
from dance_classifier.inference.predict import DanceClassifierPredictor

predictor = DanceClassifierPredictor(
    model_path="dance_classifier/models/best_model_20pct.pth",
    reference_dir="dance_classifier/reference_trajectories",  # Для метрик техники
    videos_dir="path/to/videos"  # Для метрики тайминга (опционально)
)

result = predictor.predict_from_poses("path/to/poses.jsonl", video_path="path/to/video.mp4")
```

**ВАЖНО:** Модель, scaler, label_encoder и metadata теперь загружаются автоматически из checkpoint файла (.pth). Не нужно указывать отдельные пути!

## 5. ЧТО НА ВЫХОДЕ

```json
{
    "success": true,
    "predicted_class": "FootChange",
    "confidence": 0.806,
    "spatial_similarity": {
        "score": 78.7,
        "error_segments": [...]
    },
    "timing": {
        "score": 76.2,
        "bpm": 128.3,
        "error_segments": [...]
    },
    "balance": {
        "score": 97.4,
        "error_segments": [...]
    },
    "classifier_clarity": {
        "score": 86.7,
        "error_segments": [...]
    }
}
```

## 6. МЕТРИКИ

- **spatial_similarity** (Техника): DTW-сравнение с эталоном, 0-100
- **timing** (Тайминг): Шаги vs музыка, 0-100
- **balance** (Баланс): Стабильность центра масс, 0-100
- **classifier_clarity** (Уверенность): Качество предсказания, 0-100

## 7. ПУТИ К ФАЙЛАМ

### С GITHUB:
- Весь код в `dance_classifier/`
- `dance_classifier/reference_trajectories/` - эталонные траектории для метрик (.npy файлы)
- `dance_classifier/utils/` - новые DTW метрики:
  - `spatial_similarity.py` - метрика техники
  - `timing_metric.py` - метрика тайминга
  - `balance_metric.py` - метрика баланса
  - `classifier_clarity.py` - метрика уверенности

**ВАЖНО:** metadata, scaler, label_encoder теперь ВНУТРИ checkpoint файла (.pth), не нужны отдельные файлы!

### С ОБЛАКА MAIL.RU:
https://cloud.mail.ru/public/DG9E/EuZWkp6gn

- `models/best_model_20pct.pth` - модель с встроенными metadata/scaler/label_encoder
- `yolov8m-pose.pt` - модель YOLOv8 для извлечения поз
- `dataset/BDD_dataset.zip` (для обучения)
- `videos/` (примеры)

## 8. ФОРМАТ ВХОДНЫХ ДАННЫХ

**Файл:** `poses.jsonl`

Формат: JSON Lines, где каждая строка - кадр с позами от YOLOv8.

**Структура:**
```json
{
    "video_name": "video.mp4",
    "fps": 30,
    "frames": [
        {
            "frame_number": 0,
            "timestamp": 0.0,
            "pose_landmarks": [...],
            "pose_world_landmarks": [...]
        }
    ]
}
```

## 9. REQUIREMENTS

```
torch>=2.0.0
torchvision>=0.15.0
numpy>=1.24.0
scikit-learn>=1.3.0
opencv-python>=4.8.0
librosa>=0.10.0  # Для метрики тайминга (биты музыки)
soundfile>=0.12.0  # Для librosa
numba>=0.57.0  # Для ускорения librosa
ultralytics>=8.0.0  # Для YOLOv8
```

**ВАЖНО:** Добавлены новые зависимости для DTW метрик (librosa, soundfile, numba).

## 10. СОЗДАНИЕ ВИДЕО С МЕТРИКАМИ

После анализа можно создать видео с визуализацией метрик на экране.

**Использование скрипта:**

1. Отредактируйте пути в `make_video_with_metrics.py`:
```python
video_dir = Path("outputs/your_video_name")
overlay_video = video_dir / "overlay_your_video.mp4"  # Видео с скелетом
result_file = video_dir / "analysis_result.json"      # Результат анализа
output_video = video_dir / "VIDEO_S_METRIKAMI.mp4"    # Итоговое видео
```

2. Запустите:
```bash
python make_video_with_metrics.py
```

**Что показывает видео:**
- **Верхняя панель:** название фигуры и уверенность классификатора
- **Правая панель:** 5 метрик качества с прогресс-барами:
  - Technique (Техника)
  - Timing (Тайминг)
  - Balance (Баланс)
  - Dynamics (Динамика)
  - Posture (Осанка)
- **Нижняя панель:** прогресс воспроизведения

**Требования:**
- Видео с наложенным скелетом (создается `analyze_dance.py`)
- Файл `analysis_result.json` с результатами анализа

## 11. ТОЧНОСТЬ МОДЕЛИ

- **Архитектура:** TCN + GRU
- **Обучена на:** 20% датасета BDD
- **Accuracy:** ~63%
- **Classes:** 13 латинских фигур

## КОНЕЦ




