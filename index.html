<!DOCTYPE html>
<head>
    <meta charset="UTF-8" />
    <title>Главная страница</title>
    <script src="timepicker.js"></script>
    <script src="handlevideofile.js"></script>
    <script type="module" src="videocut.js"></script>

</head>
<body>

<!--Загрузка видео на сайт -->
<input type="file" accept="video/*" id="videoInput" onchange="handleVideoFile(this.files)"/>
<video id="videoPlayer"  controls muted width="640" height="360" style="display:none;" ></video>
<div id="message"></div>
  </br>
  <div id="timePickerStart" class="time-picker">
    
    <script>
      const picker_start = new TimePicker('timePickerStart', {
        name: "Start (чч:мм:сс.млс)",
        defaultValue: '00:00:00.000',
        onChange: (time) => console.log('Time changed:', time)
      });
    </script>
  </div>
  
  <div id="timePickerEnd" class="time-picker">
    <script>
      const picker_end = new TimePicker('timePickerEnd', {
        name: "End &nbsp(чч:мм:сс.млс)",
        defaultValue: '00:00:00.000',
        onChange: (time) => console.log('Time changed:', time)
      });
    </script>
  </div>

  <div id="videoCut" class="video-cut">
    <script type="module">
        import { trimVideo } from './videocut.js';

        async function uploadBlob(blob, filename) {
          const formData = new FormData();
          formData.append('video', blob, filename);
          const response = await fetch(`http://localhost:3000/upload/${filename}`, {
            method: 'POST',
            body: formData
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Ошибка загрузки');
          }

          return await response.json();
        }

        async function cutVideo() {
          try {
            const videoFile = document.getElementById("videoInput").files[0];
            const startTime = picker_start.getTimeInSeconds();
            const endTime = picker_end.getTimeInSeconds();
            const blob = await trimVideo(videoFile, startTime, endTime);
            const blobUrl = URL.createObjectURL(blob);


            console.log('Blob size:', blob.size, 'bytes');
            console.log('Blob type:', blob.type);
            console.log("URL", blobUrl);

            const uuid = blobUrl.split('/').pop();

            const filename = `${uuid}.mp4`;
            const result = await uploadBlob(blob, filename);
            console.log(result);
            alert(`Файл загружен: uploads/${filename}`);
            URL.revokeObjectURL(blobUrl);
          }
          catch (error) {
            console.error('Ошибка при обрезке видео:', error);
          }
        }
        document.getElementById("cutButton").addEventListener('click', cutVideo);

    </script>
    <button type="button" id="cutButton">Отправить</button>

  </div>


</body>
</html>
